{% extends "base.html" %}

{% block content %}
    <div class="row">
        <p><a href="javascript:history.back(1)" class="btn btn-primary">‚Üê Back</a></p>

        <h2 class="text-center">From 
            {% if url %}
                <a href="{{ url }}" target="_blank">{{ title }}</a>
            {% else %}
                {{ title }}
            {% endif %}
        </h2>
        <p class="text-center">

            <b>{{ date }} | 
                {% if coverage %}
                    <a href="{{ coverage }}" target="_blank">{{ place }}</a>
                {% else %}
                    {{ place }}
                {% endif %}
            </b>
        </p>    
        {% if open == "true" and (corpus != "ia" and corpus != "ca") %}
        <div class="col-md-6">
                {% for paragraph in paragraphs %}
                    {% set highlighted_paragraph = paragraph|replace(search_term, '<strong>' + search_term + '</strong>')|safe %}
                <p>{{ highlighted_paragraph }}</p>
                {% endfor %}
            </div>

            {% if images is not none %}
                <div class="col-md-6">
                    <img src="{{ images }}" alt="Thumbnail" onerror="this.style.display='none';" class="img-fluid ">
                </div>
            {% endif %}

        {% elif open == "false" %}
            <div class="col-md-12">
                <p>This text comes from a proprietary database and is unavailable due to copyright restrictions.</p>
            </div>
        
            <div class="col-md-12">
                {% if url is not none %}
                    <p><a href="{{ url }}" target="_blank">{{ url }}</a></p>
                {% endif %}
            </div>
        
        {% elif corpus == "ia" %}
        <div id="ia-mirador"></div>

        {% elif corpus == "ca" %}

        <div id="ca-mirador"></div>



        {% endif %}

<script type="text/javascript">
document.addEventListener("DOMContentLoaded", async function () {
  const ia_manifestId = `https://iiif.archive.org/iiif/3/{{ manifest_id }}/manifest.json`;
  const rawCanvasIndex = {{ canvas_index }};
  const canvasIndex = Math.max(0, (rawCanvasIndex || 1)); // ensure 0-based

  const noSupplementing = (annotation) => {
  return annotation.motivation !== 'supplementing';
};


  function setupMirador(manifestId, viewerId, itemCanvasIndex) {
    const instance = Mirador.viewer({
      id: viewerId,
      windows: [{ manifestId, canvasIndex: itemCanvasIndex, view: 'single' }],
      window: {
        defaultView: 'single',
        highlightAllAnnotations: false, 
        forceDrawAnnotations: true,
        defaultSideBarPanel: 'annotations',
        sideBarOpen: true,
        canvasAnnotations: true,
        sideBarOpenByDefault: true,
        

      },
      workspaceControlPanel: { enabled: false },
  annotation: {
    filter: noSupplementing
  }
    });
    console.log("instance", instance)
    return new Promise((resolve) => {
      const poll = () => {
        const ids = Object.keys(instance.store.getState()?.windows || {});
        if (ids.length) return resolve({ instance, windowId: ids[0] });
        setTimeout(poll, 50);
      };
      poll();
    });
  }

  

  try {
    const r = await fetch(ia_manifestId);
    const manifest = await r.json();
    const page = manifest.items?.[canvasIndex];
    if (!page) return;

    const dims = { width: page.width, height: page.height };

    const { instance, windowId } = await setupMirador(ia_manifestId, 'ia-mirador', canvasIndex);

    const state = instance.store.getState();
    const currentCanvasId = state.windows?.[windowId]?.canvasId || page.id;

    // console.log("üñºÔ∏è Mirador's canvasId:", currentCanvasId);


// build the *server* URL, passing the canvas id as a query param
const clustersCsv = /* build your list or derive from UI */ '';
const annoUrl = `/annotations/{{ doc_id }}.json?canvasId=${encodeURIComponent(currentCanvasId)}${clustersCsv ? `&clusters=${clustersCsv}` : ''}`;
  // const annoBase = `/annotations/{{ doc_id }}.json`;
  // console.log(annoBase)

    // console.log("canvasid", currentCanvasId)

    fetch(annoUrl)
  .then(response => {
    if (!response.ok) {
      throw new Error("Network response was not ok " + response.statusText);
    }
    return response.json();
  })


    // timeout gives mirador time to load before loading annotaitons
    setTimeout(() => {
    instance.store.dispatch(Mirador.actions.requestAnnotation(currentCanvasId, annoUrl));
    }, 300);

    const m = ("{{ images }}".match(/\/pct:([\d.]+),([\d.]+),([\d.]+),([\d.]+)\//) || []);
    if (m.length === 5) {
      const pct = { x:+m[1], y:+m[2], w:+m[3], h:+m[4] };
      const px  = {
        x: (pct.x/100)*dims.width,
        y: (pct.y/100)*dims.height,
        w: (pct.w/100)*dims.width,
        h: (pct.h/100)*dims.height,
      };
      const center = { x: px.x + px.w/2, y: px.y + px.h/2 };
      const action = Mirador.actions.updateViewport(windowId, { x: center.x, y: center.y, zoom: 0.5/px.w });
      setTimeout(() => instance.store.dispatch(action), 400);
    }
  } catch (e) {
    console.error('[M3] IA error:', e);
  }

  
});
</script>


<style>
  /* Make all annotation rectangles stand out a bit more */
  [data-annotation-id] rect {
  stroke: rgba(255,0,0,0.9) !important;
  stroke-width: 3 !important;
  fill: rgba(255,0,0,0.10) !important;
}
</style>


    </div>
{% endblock %}



